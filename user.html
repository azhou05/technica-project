<!DOCTYPE html>
<html class="html">
<head>
    <title>EasiPeasi Expense Tracker</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="user.css" rel="stylesheet" type="text/css" />
    <style>
        #add-expense, #expense-history, #receipt-history {
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <br>
        <button class="openbtn" onclick="openNav()">&#9776</button>
        <button class="closebtn" onclick="closeNav()">&#10006</button>
        <div class="topbtn">
          <topbtn type="button column1" ><a href="index.html" style="color:#000000;">Log Out</a></topbtn>
        </div>
        <br>
    </header>
    <!-- sidebar -->
    <div class="sidebar" id="mySidebar">
        <div class="logoname column1">
            <img class="logo" src="assets/cats.png" alt="Expense Snap Logo">
            <h3>Expense Snap</h3>
        </div>
        <h2>EasiPeasi</h2>
        <button onclick="toggleSection('main'); closeNav()">Analytics</button>
        <button onclick="toggleSection('add-expense'); closeNav()">Add Expense</button>
        <button onclick="toggleSection('expense-history'); closeNav()">Expense History</button>
        <button onclick="toggleSection('receipt-history'); closeNav()">Receipt History</button>
    </div>

    <div id="main">
        <h2>Analytics Overview</h2>
        <p>Here is a summary of your spending through the past week, month, and year.</p>
    </div>

    <!-- main content area -->
    <div class="main-content">
        <!-- add expense section -->
        <section id="add-expense">
            <h2>Add a New Expense</h2>
            <form id="expense-form">
                <label for="expense-date">Date:</label>
                <input type="date" id="expense-date" name="expense-date" required>

                <label for="expense-amount">Amount:</label>
                <input type="number" id="expense-amount" name="expense-amount" required>

                <label for="expense-category">Category:</label>
                <select id="expense-category" name="expense-category">
                    <option value="food">Food</option>
                    <option value="transportation">Transportation</option>
                    <option value="entertainment">Entertainment</option>
                    <option value="utilities">Utilities</option>
                    <option value="other">Other</option>
                </select>

                <button type="submit"><p>Submit</p></button>
            </form>
            <h2>Add a New Receipt</h2>
            <form id="receipt-form">
                <label for="receipt-upload">Upload Receipt:</label>
                <input type="file" id="receipt-upload" name="receipt-upload" accept="image/*" required style="display: none;">
                <button type="button" id="custom-file-upload"><p>Choose File</p></button>
                <span id="file-chosen">No file chosen</span>
                <button type="submit"><p>Submit</p></button>
            </form>
        </section>

        <!-- expense history section -->
        <section id="expense-history">
            <h2>Your Expense History</h2>
            <div id="total-expense-display">Total Expenses: $0.00</div>
            <br>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="expense-table-body">
                    <!-- here expenses will be dynamically inserted -->
                </tbody>
            </table>
        </section>

        <section id="receipt-history">
            <h2>Your Receipt History</h2>
            <div id="receipt-table-body">
                <!-- Uploaded receipts will be displayed here -->
            </div>
        </section>
        
    </div>

    <footer>
        <p>Designed and Created by Emily, Annie, Seungha, and Ivy.</p>
    </footer>

    <script>

        document.addEventListener('DOMContentLoaded', function() {
            showDashboard();

            document.getElementById('custom-file-upload').addEventListener('click', function() {
                document.getElementById('receipt-upload').click();
            });

            document.getElementById('receipt-upload').addEventListener('change', function() {
                const fileName = this.files[0] ? this.files[0].name : 'No file chosen';
                document.getElementById('file-chosen').textContent = fileName;
            });
        });


        function openNav() {
            document.getElementById("mySidebar").style.width = "250px";
            document.getElementById("main").style.marginLeft = "250px";
            document.querySelector(".main-content").style.marginLeft = "250px";
            document.querySelector("footer").style.marginLeft = "250px";
            document.querySelector(".openbtn").style.display = "none";
            document.querySelector(".closebtn").style.display = "block";
        }

        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
            document.querySelector(".main-content").style.marginLeft = "0";
            document.querySelector("footer").style.marginLeft = "0";
            document.querySelector(".openbtn").style.display = "block";
            document.querySelector(".closebtn").style.display = "none"; 
        }

        function toggleSection(sectionId) {
            document.getElementById('main').style.display = 'none';
            document.getElementById('add-expense').style.display = 'none';
            document.getElementById('expense-history').style.display = 'none';
            document.getElementById('receipt-history').style.display = 'none';

            document.getElementById(sectionId).style.display = 'block';

            if (sectionId === 'expense-history') {
                loadExpenses();
            } else if (sectionId === 'receipt-history') {
                loadReceipts();
            }
        }

        function showDashboard() {
            document.getElementById('main').style.display = 'block';
            document.getElementById('add-expense').style.display = 'none';
            document.getElementById('expense-history').style.display = 'none';
            document.getElementById('receipt-history').style.display = 'none';
        }

        function logout() {
            alert("Logging out...");
        }

        // handle adding receipt
        document.getElementById('expense-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const date = document.getElementById('expense-date').value;
            const amount = document.getElementById('expense-amount').value;
            const category = document.getElementById('expense-category').value;

            const expense = {
                date: date,
                amount: amount,
                category: category,
            };

            saveExpense(expense);

            addExpenseToTable(expense);

            document.getElementById('expense-form').reset();
        });

        // handle uploading receipt
        document.getElementById('receipt-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('receipt-upload');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const receiptData = event.target.result;
                    alert('Receipt uploaded successfully!');
                    fileInput.value = '';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please select a receipt to upload.');
            }
        });

        function saveExpense(expense) {
            let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            document.getElementById('expense-table-body').innerHTML = ''; // Clear existing entries

            let totalExpense = 0; // Initialize total expense

            expenses.forEach((expense, index) => {
                addExpenseToTable(expense, index);
                totalExpense += parseFloat(expense.amount); // Accumulate total expense
            });

            // Update the total expenses display
            document.getElementById('total-expense-display').textContent = `Total Expenses: $${totalExpense.toFixed(2)}`;
        }

        function addExpenseToTable(expense, index) {
            const tableBody = document.getElementById('expense-table-body');
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${expense.date}</td>
                <td>$${parseFloat(expense.amount).toFixed(2)}</td>
                <td>${expense.category}</td>
                <td><button class="delete-expense-btn" data-index="${index}">Delete</button></td>
            `;
            tableBody.appendChild(row);

            row.querySelector('.delete-expense-btn').addEventListener('click', function() {
                deleteExpense(index);
            });
        }

        function deleteExpense(index) {
            if (confirm('Are you sure you want to delete this expense?')) {
                let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                expenses.splice(index, 1); // Remove the expense from the array
                localStorage.setItem('expenses', JSON.stringify(expenses)); // Update local storage
                loadExpenses(); // Re-load expenses to update the UI
            }
        }

        function saveReceipt(receiptData) {
            let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            receipts.push({
                data: receiptData,
                date: new Date().toISOString().split('T')[0],
                id: Date.now()  // unique identifier for each receipt
            });
            localStorage.setItem('receipts', JSON.stringify(receipts));
        }

        function loadReceipts() {
            const receipts = JSON.parse(localStorage.getItem('receipts')) || [];
            const receiptContainer = document.getElementById('receipt-table-body');
            receiptContainer.innerHTML = ''; // Clear existing entries
            
            // Create grid container
            const gridContainer = document.createElement('div');
            gridContainer.className = 'receipt-grid';
            receiptContainer.appendChild(gridContainer);

            receipts.forEach(receipt => {
                displayReceipt(receipt, gridContainer);
            });
        }

        function displayReceipt(receipt, container) {
            const receiptDiv = document.createElement('div');
            receiptDiv.className = 'receipt-item';
            receiptDiv.innerHTML = `
                <img src="${receipt.data}" alt="Receipt" class="receipt-image">
                <div class="receipt-date">${receipt.date}</div>
                <button class="delete-receipt-btn" data-id="${receipt.id}">&times;</button>
            `;

            // Add click handler for image to show modal
            receiptDiv.querySelector('.receipt-image').addEventListener('click', () => {
                showReceiptModal(receipt.data);
            });

            // Add click handler for delete button
            receiptDiv.querySelector('.delete-receipt-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteReceipt(receipt.id);
            });

            container.appendChild(receiptDiv);
        }

        function deleteReceipt(receiptId) {
            if (confirm('Are you sure you want to delete this receipt?')) {
                let receipts = JSON.parse(localStorage.getItem('receipts')) || [];
                receipts = receipts.filter(receipt => receipt.id !== receiptId);
                localStorage.setItem('receipts', JSON.stringify(receipts));
                loadReceipts();
            }
        }

        function showReceiptModal(receiptData) {
            // Create modal if it doesn't exist
            let modal = document.querySelector('.receipt-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'receipt-modal';
                modal.innerHTML = `
                    <span class="close-modal">&times;</span>
                    <div class="modal-content">
                        <img src="" alt="Receipt">
                    </div>
                `;
                document.body.appendChild(modal);

                // Add click handler to close modal
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.className === 'close-modal') {
                        modal.style.display = 'none';
                    }
                });
            }

            // Update modal image and display it
            modal.querySelector('img').src = receiptData;
            modal.style.display = 'flex';
        }

        document.getElementById('receipt-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const fileInput = document.getElementById('receipt-upload');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const receiptData = event.target.result;
                    saveReceipt(receiptData);
                    loadReceipts(); // Reload all receipts
                    alert('Receipt uploaded successfully!');
                    fileInput.value = ''; // Clear the input after uploading
                    document.getElementById('file-chosen').textContent = 'No file chosen';
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please select a receipt to upload.');
            }
        });

    </script>
    
</body>
</html>